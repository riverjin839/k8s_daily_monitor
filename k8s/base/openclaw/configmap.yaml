# ============================================
# OpenClaw - Alert Agent Configuration
# Controls what OpenClaw watches and where it sends alerts.
# ============================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: openclaw-config
  namespace: k8s-monitor
  labels:
    app.kubernetes.io/name: openclaw
    app.kubernetes.io/part-of: k8s-daily-monitor
data:
  # ---- Agent behaviour ----
  OPENCLAW_MODE: "alert-only"
  OPENCLAW_READONLY: "true"

  # ---- K8s watch settings ----
  WATCH_NAMESPACES: ""                          # empty = all namespaces
  WATCH_EVENT_TYPES: "Warning"                  # Warning | Normal | Warning,Normal
  ERROR_PATTERNS: "CrashLoopBackOff,OOMKilled,ImagePullBackOff,ErrImagePull,FailedScheduling,Unhealthy,BackOff"
  WATCH_INTERVAL_SECONDS: "30"

  # ---- Ollama integration (for AI-enriched alerts) ----
  OLLAMA_URL: "http://ollama:11434"
  OLLAMA_MODEL: "llama3"

  # ---- Backend webhook (forward alerts to k8s-monitor backend) ----
  BACKEND_WEBHOOK_URL: "http://backend:8000/api/v1/openclaw/webhook"

  # ---- Alert rules (JSON) ----
  alert-rules.json: |
    {
      "rules": [
        {
          "name": "CrashLoopBackOff",
          "event_reason": "BackOff",
          "severity": "critical",
          "message_template": "[CRITICAL] Pod {pod_name} in namespace {namespace} is in CrashLoopBackOff"
        },
        {
          "name": "OOMKilled",
          "event_reason": "OOMKilling",
          "severity": "critical",
          "message_template": "[CRITICAL] Container in pod {pod_name} ({namespace}) was OOMKilled"
        },
        {
          "name": "ImagePullBackOff",
          "event_reason": "Failed",
          "event_message_contains": "ImagePullBackOff",
          "severity": "warning",
          "message_template": "[WARNING] Pod {pod_name} ({namespace}) cannot pull image"
        },
        {
          "name": "FailedScheduling",
          "event_reason": "FailedScheduling",
          "severity": "warning",
          "message_template": "[WARNING] Pod {pod_name} ({namespace}) scheduling failed: {message}"
        },
        {
          "name": "Unhealthy",
          "event_reason": "Unhealthy",
          "severity": "warning",
          "message_template": "[WARNING] Pod {pod_name} ({namespace}) health probe failed: {message}"
        }
      ]
    }
