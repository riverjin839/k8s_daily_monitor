# ============================================
# Air-Gap + OpenClaw — Composite overlay
# ============================================
#
# Deploys the full stack + OpenClaw with all images
# pulled from the internal registry (10.61.162.101:5000).
#
# Usage:
#   kubectl apply -k k8s/overlays/airgap-openclaw/
# ============================================
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: k8s-monitor

resources:
  - ../../base
  - ../../base/openclaw

# Internal registry image mapping
images:
  - name: k8s-daily-monitor/backend
    newName: 10.61.162.101:5000/k8s-monitor/backend
    newTag: latest
  - name: k8s-daily-monitor/frontend
    newName: 10.61.162.101:5000/k8s-monitor/frontend
    newTag: latest
  - name: postgres:15-alpine
    newName: 10.61.162.101:5000/library/postgres
    newTag: 15-alpine
  - name: redis:7-alpine
    newName: 10.61.162.101:5000/library/redis
    newTag: 7-alpine
  # Monitoring stack
  - name: prom/prometheus:v2.51.0
    newName: 10.61.162.101:5000/prom/prometheus
    newTag: v2.51.0
  - name: grafana/grafana:10.4.0
    newName: 10.61.162.101:5000/grafana/grafana
    newTag: "10.4.0"
  - name: registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.12.0
    newName: 10.61.162.101:5000/kube-state-metrics/kube-state-metrics
    newTag: v2.12.0
  - name: prom/node-exporter:v1.7.0
    newName: 10.61.162.101:5000/prom/node-exporter
    newTag: v1.7.0
  # OpenClaw (air-gap)
  - name: openclaw/openclaw:latest
    newName: 10.61.162.101:5000/openclaw/openclaw
    newTag: latest

patches:
  # Ingress 비활성화
  - patch: |-
      $patch: delete
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: k8s-monitor-ingress
    target:
      kind: Ingress

  # Frontend NodePort
  - patch: |-
      - op: replace
        path: /spec/type
        value: NodePort
      - op: add
        path: /spec/ports/0/nodePort
        value: 30080
    target:
      kind: Service
      name: frontend

  # Backend NodePort
  - patch: |-
      - op: replace
        path: /spec/type
        value: NodePort
      - op: add
        path: /spec/ports/0/nodePort
        value: 30800
    target:
      kind: Service
      name: backend

  # Prometheus NodePort
  - patch: |-
      - op: replace
        path: /spec/type
        value: NodePort
      - op: add
        path: /spec/ports/0/nodePort
        value: 30090
    target:
      kind: Service
      name: prometheus

  # Grafana NodePort
  - patch: |-
      - op: replace
        path: /spec/type
        value: NodePort
      - op: add
        path: /spec/ports/0/nodePort
        value: 30030
    target:
      kind: Service
      name: grafana

  # HPA 비활성화
  - patch: |-
      $patch: delete
      apiVersion: autoscaling/v2
      kind: HorizontalPodAutoscaler
      metadata:
        name: backend-hpa
    target:
      kind: HorizontalPodAutoscaler
      name: backend-hpa
  - patch: |-
      $patch: delete
      apiVersion: autoscaling/v2
      kind: HorizontalPodAutoscaler
      metadata:
        name: celery-worker-hpa
    target:
      kind: HorizontalPodAutoscaler
      name: celery-worker-hpa
  - patch: |-
      $patch: delete
      apiVersion: autoscaling/v2
      kind: HorizontalPodAutoscaler
      metadata:
        name: frontend-hpa
    target:
      kind: HorizontalPodAutoscaler
      name: frontend-hpa

  # 레플리카 축소
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
    target:
      kind: Deployment

configMapGenerator:
  - name: k8s-monitor-config
    behavior: merge
    literals:
      - DEBUG=true
      - CHECK_INTERVAL_MINUTES=5

secretGenerator:
  - name: k8s-monitor-secret
    behavior: merge
    literals:
      - DATABASE_PASSWORD=postgres
      - SECRET_KEY=airgap-secret-key-change-this
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/k8s_monitor
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0

generatorOptions:
  disableNameSuffixHash: true
