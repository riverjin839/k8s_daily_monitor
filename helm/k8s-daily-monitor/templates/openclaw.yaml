{{- if .Values.openclaw.enabled }}
# ============================================
# OpenClaw â€” AI Alert Agent (Optional)
# Only deployed when openclaw.enabled=true
# ============================================

# --- ServiceAccount (dedicated, minimal) ---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: openclaw-sa
  labels:
    {{- include "k8s-daily-monitor.labels" . | nindent 4 }}
    app.kubernetes.io/component: openclaw
---

# --- ClusterRole: Read-Only (pods, pods/log, events ONLY) ---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ .Release.Namespace }}-openclaw-readonly
  labels:
    {{- include "k8s-daily-monitor.labels" . | nindent 4 }}
    app.kubernetes.io/component: openclaw
rules:
  - apiGroups: [""]
    resources: [pods]
    verbs: [get, list, watch]
  - apiGroups: [""]
    resources: [pods/log]
    verbs: [get, list, watch]
  - apiGroups: [""]
    resources: [events]
    verbs: [get, list, watch]
  - apiGroups: ["events.k8s.io"]
    resources: [events]
    verbs: [get, list, watch]
---

# --- ClusterRoleBinding ---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ .Release.Namespace }}-openclaw-readonly-binding
  labels:
    {{- include "k8s-daily-monitor.labels" . | nindent 4 }}
    app.kubernetes.io/component: openclaw
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ .Release.Namespace }}-openclaw-readonly
subjects:
  - kind: ServiceAccount
    name: openclaw-sa
    namespace: {{ .Release.Namespace }}
---

# --- Messenger Secret ---
apiVersion: v1
kind: Secret
metadata:
  name: openclaw-messenger-secret
  labels:
    {{- include "k8s-daily-monitor.labels" . | nindent 4 }}
    app.kubernetes.io/component: openclaw
type: Opaque
stringData:
  TELEGRAM_BOT_TOKEN: {{ .Values.openclaw.telegram.botToken | quote }}
  TELEGRAM_CHAT_ID: {{ .Values.openclaw.telegram.chatId | quote }}
  SLACK_WEBHOOK_URL: {{ .Values.openclaw.slack.webhookUrl | quote }}
---

# --- ConfigMap ---
apiVersion: v1
kind: ConfigMap
metadata:
  name: openclaw-config
  labels:
    {{- include "k8s-daily-monitor.labels" . | nindent 4 }}
    app.kubernetes.io/component: openclaw
data:
  OPENCLAW_MODE: "alert-only"
  OPENCLAW_READONLY: "true"
  WATCH_NAMESPACES: {{ .Values.openclaw.watch.namespaces | quote }}
  WATCH_EVENT_TYPES: {{ .Values.openclaw.watch.eventTypes | quote }}
  ERROR_PATTERNS: {{ .Values.openclaw.watch.errorPatterns | quote }}
  WATCH_INTERVAL_SECONDS: {{ .Values.openclaw.watch.intervalSeconds | quote }}
  OLLAMA_URL: "http://ollama:11434"
  OLLAMA_MODEL: "llama3"
  BACKEND_WEBHOOK_URL: "http://backend:8000/api/v1/openclaw/webhook"
  alert-rules.json: |
    {
      "rules": [
        {"name": "CrashLoopBackOff", "event_reason": "BackOff", "severity": "critical"},
        {"name": "OOMKilled", "event_reason": "OOMKilling", "severity": "critical"},
        {"name": "ImagePullBackOff", "event_reason": "Failed", "severity": "warning"},
        {"name": "FailedScheduling", "event_reason": "FailedScheduling", "severity": "warning"},
        {"name": "Unhealthy", "event_reason": "Unhealthy", "severity": "warning"}
      ]
    }
---

# --- Deployment ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: openclaw
  labels:
    {{- include "k8s-daily-monitor.labels" . | nindent 4 }}
    app: openclaw
    app.kubernetes.io/component: openclaw
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: openclaw
  template:
    metadata:
      labels:
        app: openclaw
        app.kubernetes.io/component: openclaw
    spec:
      serviceAccountName: openclaw-sa
      automountServiceAccountToken: true
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
        - name: openclaw
          image: {{ include "k8s-daily-monitor.image" (dict "global" .Values.global "repository" .Values.openclaw.image.repository "tag" .Values.openclaw.image.tag) }}
          imagePullPolicy: {{ .Values.openclaw.image.pullPolicy }}
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]
          env:
            - name: OPENCLAW_MODE
              valueFrom:
                configMapKeyRef:
                  name: openclaw-config
                  key: OPENCLAW_MODE
            - name: OPENCLAW_READONLY
              valueFrom:
                configMapKeyRef:
                  name: openclaw-config
                  key: OPENCLAW_READONLY
            - name: WATCH_NAMESPACES
              valueFrom:
                configMapKeyRef:
                  name: openclaw-config
                  key: WATCH_NAMESPACES
            - name: WATCH_EVENT_TYPES
              valueFrom:
                configMapKeyRef:
                  name: openclaw-config
                  key: WATCH_EVENT_TYPES
            - name: ERROR_PATTERNS
              valueFrom:
                configMapKeyRef:
                  name: openclaw-config
                  key: ERROR_PATTERNS
            - name: WATCH_INTERVAL_SECONDS
              valueFrom:
                configMapKeyRef:
                  name: openclaw-config
                  key: WATCH_INTERVAL_SECONDS
            - name: OLLAMA_URL
              valueFrom:
                configMapKeyRef:
                  name: openclaw-config
                  key: OLLAMA_URL
            - name: OLLAMA_MODEL
              valueFrom:
                configMapKeyRef:
                  name: openclaw-config
                  key: OLLAMA_MODEL
            - name: BACKEND_WEBHOOK_URL
              valueFrom:
                configMapKeyRef:
                  name: openclaw-config
                  key: BACKEND_WEBHOOK_URL
            - name: TELEGRAM_BOT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: openclaw-messenger-secret
                  key: TELEGRAM_BOT_TOKEN
                  optional: true
            - name: TELEGRAM_CHAT_ID
              valueFrom:
                secretKeyRef:
                  name: openclaw-messenger-secret
                  key: TELEGRAM_CHAT_ID
                  optional: true
            - name: SLACK_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: openclaw-messenger-secret
                  key: SLACK_WEBHOOK_URL
                  optional: true
          volumeMounts:
            - name: workspace
              mountPath: /app/workspace
              readOnly: true
            - name: tmp
              mountPath: /tmp
          resources:
            {{- toYaml .Values.openclaw.resources | nindent 12 }}
          ports:
            - containerPort: 8080
              name: http
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 10
      volumes:
        - name: workspace
          configMap:
            name: openclaw-config
            items:
              - key: alert-rules.json
                path: alert-rules.json
        - name: tmp
          emptyDir:
            sizeLimit: 100Mi
---

# --- Service ---
apiVersion: v1
kind: Service
metadata:
  name: openclaw
  labels:
    {{- include "k8s-daily-monitor.labels" . | nindent 4 }}
    app: openclaw
    app.kubernetes.io/component: openclaw
spec:
  type: ClusterIP
  selector:
    app: openclaw
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
      name: http
{{- end }}
