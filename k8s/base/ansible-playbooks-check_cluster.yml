---
# K8s Cluster Health Check Playbook
# 사용법: ansible-playbook check_cluster.yml -e "target_cluster=prod-cluster"

- name: K8s Cluster Health Check
  hosts: localhost
  gather_facts: no
  
  vars:
    target_cluster: "{{ target_cluster | default('default') }}"
    api_endpoint: "{{ api_endpoint | default('https://kubernetes.default.svc') }}"
    kubeconfig_path: "{{ kubeconfig_path | default('~/.kube/config') }}"
    
  tasks:
    - name: Check API Server Health
      uri:
        url: "{{ api_endpoint }}/healthz"
        method: GET
        validate_certs: no
        timeout: 10
      register: api_health
      ignore_errors: yes
      
    - name: Set API Server status
      set_fact:
        api_status: "{{ 'healthy' if api_health.status == 200 else 'critical' }}"
      
    - name: Check API Server livez
      uri:
        url: "{{ api_endpoint }}/livez"
        method: GET
        validate_certs: no
        timeout: 10
      register: api_livez
      ignore_errors: yes

    - name: Check API Server readyz
      uri:
        url: "{{ api_endpoint }}/readyz"
        method: GET
        validate_certs: no
        timeout: 10
      register: api_readyz
      ignore_errors: yes

    - name: Get cluster nodes
      command: >
        kubectl get nodes 
        --kubeconfig={{ kubeconfig_path }}
        -o json
      register: nodes_output
      ignore_errors: yes
      changed_when: false

    - name: Parse nodes status
      set_fact:
        nodes_info: "{{ nodes_output.stdout | from_json }}"
      when: nodes_output.rc == 0
      ignore_errors: yes

    - name: Get component statuses
      command: >
        kubectl get componentstatuses
        --kubeconfig={{ kubeconfig_path }}
        -o json
      register: components_output
      ignore_errors: yes
      changed_when: false

    - name: Check kube-system pods
      command: >
        kubectl get pods -n kube-system
        --kubeconfig={{ kubeconfig_path }}
        -o json
      register: kube_system_pods
      ignore_errors: yes
      changed_when: false

    - name: Generate health report
      set_fact:
        health_report:
          cluster: "{{ target_cluster }}"
          api_server:
            healthz: "{{ api_health.status | default('error') }}"
            livez: "{{ api_livez.status | default('error') }}"
            readyz: "{{ api_readyz.status | default('error') }}"
          timestamp: "{{ ansible_date_time.iso8601 | default(lookup('pipe', 'date -Iseconds')) }}"

    - name: Display health report
      debug:
        var: health_report
        
    - name: Write report to file
      copy:
        content: "{{ health_report | to_nice_json }}"
        dest: "/tmp/cluster_health_{{ target_cluster }}.json"
      delegate_to: localhost
