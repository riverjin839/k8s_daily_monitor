apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: k8s-monitor-prod

namePrefix: prod-

resources:
  - ../../base

patches:
  # Increase replicas for production
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 3
    target:
      kind: Deployment
      name: backend
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 3
    target:
      kind: Deployment
      name: frontend
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 3
    target:
      kind: Deployment
      name: celery-worker

  # Increase resources for production
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 512Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 500m
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 1Gi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 1000m
    target:
      kind: Deployment
      name: backend

  # Increase PostgreSQL resources for production
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 512Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 500m
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 2Gi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 1000m
      - op: replace
        path: /spec/volumeClaimTemplates/0/spec/resources/requests/storage
        value: 50Gi
    target:
      kind: StatefulSet
      name: postgres

  # Update HPA for production
  - patch: |-
      - op: replace
        path: /spec/minReplicas
        value: 3
      - op: replace
        path: /spec/maxReplicas
        value: 15
    target:
      kind: HorizontalPodAutoscaler
      name: backend-hpa
  - patch: |-
      - op: replace
        path: /spec/minReplicas
        value: 3
      - op: replace
        path: /spec/maxReplicas
        value: 12
    target:
      kind: HorizontalPodAutoscaler
      name: celery-worker-hpa

  # Update ingress host for production
  - patch: |-
      - op: replace
        path: /spec/rules/0/host
        value: k8s-monitor.example.com
    target:
      kind: Ingress
      name: k8s-monitor-ingress

  # Add TLS for production ingress
  - patch: |-
      - op: add
        path: /metadata/annotations/cert-manager.io~1cluster-issuer
        value: letsencrypt-prod
      - op: add
        path: /spec/tls
        value:
          - hosts:
              - k8s-monitor.example.com
            secretName: k8s-monitor-tls
    target:
      kind: Ingress
      name: k8s-monitor-ingress

configMapGenerator:
  - name: k8s-monitor-config
    behavior: merge
    literals:
      - DEBUG=false
      - CHECK_INTERVAL_MINUTES=5

# Production secrets should be managed externally (e.g., External Secrets, Sealed Secrets)
# This is a placeholder - DO NOT commit real production secrets
secretGenerator:
  - name: k8s-monitor-secret
    behavior: merge
    literals:
      - DATABASE_PASSWORD=CHANGE_ME_IN_PRODUCTION
      - SECRET_KEY=CHANGE_ME_IN_PRODUCTION
      - DATABASE_URL=postgresql://postgres:CHANGE_ME_IN_PRODUCTION@prod-postgres:5432/k8s_monitor
      - REDIS_URL=redis://prod-redis:6379/0
      - CELERY_BROKER_URL=redis://prod-redis:6379/0
      - CELERY_RESULT_BACKEND=redis://prod-redis:6379/0

generatorOptions:
  disableNameSuffixHash: true
